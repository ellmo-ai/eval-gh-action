name: 'Ellmo Run Evals'
description: 'Run Ellmo evals on changed LLM prompts.'
inputs:
  github-token:
    description: 'GitHub token'
    required: true
  config-path:
    description: 'Path to the ellmo.config.json file'
    required: false
    default: './ellmo.config.json'
runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci
      shell: bash

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        token: ${{ inputs.github-token }}

    - name: Run associated evals
      run: |
        config_content=$(cat ${{ inputs.config-path }})
        promptsPath=$(echo "$config_content" | jq -r .promptsPath)

        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ $file == $promptsPath/* ]]; then
            echo "Checking file: $file"
            npx @polay-ai/ts-sdk --path "$file"
            if [ $? -ne 0 ]; then
              echo "Check failed for $file"
              exit 1
            fi
          fi
        done
      shell: bash

